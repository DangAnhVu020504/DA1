<div class="my-properties-container">
    <div class="page-header">
        <h1>ğŸ  Quáº£n lÃ½ Báº¥t Ä‘á»™ng sáº£n</h1>
        <button *ngIf="!showForm" class="btn-create" (click)="openCreateForm()">
            â• Táº¡o BDS má»›i
        </button>
    </div>

    <!-- Search & Filter Bar -->
    <div *ngIf="!showForm && properties.length > 0" class="filter-bar">
        <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()"
            placeholder="ğŸ” TÃ¬m theo tiÃªu Ä‘á», Ä‘á»‹a chá»‰..." class="search-input">

        <select [(ngModel)]="statusFilter" (ngModelChange)="onStatusFilterChange()" class="status-select">
            <option value="all">ğŸ“‹ Táº¥t cáº£ tráº¡ng thÃ¡i</option>
            <option value="available">âœ… Äang hiá»ƒn thá»‹</option>
            <option value="sold">ğŸ·ï¸ ÄÃ£ bÃ¡n</option>
            <option value="rented">ğŸ”‘ ÄÃ£ cho thuÃª</option>
        </select>

        <span class="result-count">{{ filteredProperties.length }} / {{ properties.length }} tin</span>
    </div> <!-- Inline Form -->
    <div *ngIf="showForm" class="property-form-container">
        <div class="form-header">
            <h2>{{ isEditing ? 'âœï¸ Sá»­a Báº¥t Ä‘á»™ng sáº£n' : 'â• Táº¡o BDS má»›i' }}</h2>
            <button class="close-form-btn" (click)="closeForm()">âœ•</button>
        </div>

        <div *ngIf="formError" class="alert alert-danger">{{ formError }}</div>

        <form (ngSubmit)="onSubmit()" #form="ngForm">
            <div class="form-row">
                <div class="form-group">
                    <label>TiÃªu Ä‘á» tin *</label>
                    <input type="text" [(ngModel)]="property.title" name="title" required class="form-control"
                        placeholder="VD: NhÃ  phá»‘ 3 táº§ng Quáº­n 7">
                </div>
            </div>

            <div class="form-row two-columns">
                <div class="form-group">
                    <label>Loáº¡i giao dá»‹ch *</label>
                    <select [(ngModel)]="property.listingTypeId" name="listingTypeId" required class="form-control">
                        <option [ngValue]="null">-- Chá»n loáº¡i --</option>
                        <option *ngFor="let lt of listingTypes" [ngValue]="lt.id">{{ lt.name }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Loáº¡i BÄS *</label>
                    <select [(ngModel)]="property.typeId" name="typeId" required class="form-control">
                        <option [ngValue]="null">-- Chá»n loáº¡i BÄS --</option>
                        <option *ngFor="let pt of propertyTypes" [ngValue]="pt.id">{{ pt.name }}</option>
                    </select>
                </div>
            </div>

            <div class="form-row two-columns">
                <div class="form-group">
                    <label>Tá»‰nh/ThÃ nh phá»‘ *</label>
                    <select [(ngModel)]="selectedCityId" name="cityId" (ngModelChange)="onCityChange()" required
                        class="form-control">
                        <option [ngValue]="null">-- Chá»n thÃ nh phá»‘ --</option>
                        <option *ngFor="let city of cities" [ngValue]="city.id">{{ city.name }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quáº­n/Huyá»‡n *</label>
                    <select [(ngModel)]="property.districtId" name="districtId" required class="form-control"
                        [disabled]="!selectedCityId">
                        <option [ngValue]="null">-- Chá»n quáº­n/huyá»‡n --</option>
                        <option *ngFor="let d of districts" [ngValue]="d.id">{{ d.name }}</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Äá»‹a chá»‰ cá»¥ thá»ƒ *</label>
                    <input type="text" [(ngModel)]="property.address" name="address" required class="form-control"
                        placeholder="Sá»‘ nhÃ , tÃªn Ä‘Æ°á»ng">
                </div>
            </div>

            <div class="form-row two-columns">
                <div class="form-group">
                    <label>Má»©c giÃ¡ (VND) *</label>
                    <input type="number" [(ngModel)]="property.price" name="price" required class="form-control">
                </div>

                <div class="form-group">
                    <label>Diá»‡n tÃ­ch (mÂ²) *</label>
                    <input type="number" [(ngModel)]="property.area" name="area" required class="form-control">
                </div>
            </div>

            <div class="form-row two-columns">
                <div class="form-group">
                    <label>Sá»‘ phÃ²ng ngá»§</label>
                    <input type="number" [(ngModel)]="property.bedrooms" name="bedrooms" class="form-control" min="0">
                </div>

                <div class="form-group">
                    <label>Sá»‘ phÃ²ng táº¯m</label>
                    <input type="number" [(ngModel)]="property.bathrooms" name="bathrooms" class="form-control" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>MÃ´ táº£ chi tiáº¿t</label>
                    <textarea [(ngModel)]="property.description" name="description" rows="4" class="form-control"
                        placeholder="MÃ´ táº£ chi tiáº¿t vá» báº¥t Ä‘á»™ng sáº£n..."></textarea>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>HÃ¬nh áº£nh mÃ´ táº£</label>
                    <input type="file" (change)="onFileSelected($event)" accept="image/*" class="form-control-file">
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" [disabled]="!form.valid || formLoading" class="btn btn-primary">
                    {{ formLoading ? 'Äang xá»­ lÃ½...' : (isEditing ? 'ğŸ’¾ LÆ°u thay Ä‘á»•i' : 'ğŸ“¤ Táº¡o BDS') }}
                </button>
                <button type="button" (click)="closeForm()" class="btn btn-secondary">Há»§y</button>
            </div>
        </form>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading">
        <div class="spinner"></div>
        <p>Äang táº£i danh sÃ¡ch...</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && !showForm && properties.length === 0" class="empty-state">
        <div class="empty-icon">ğŸ¡</div>
        <h3>Báº¡n chÆ°a cÃ³ báº¥t Ä‘á»™ng sáº£n nÃ o</h3>
        <p>Báº¯t Ä‘áº§u báº±ng cÃ¡ch táº¡o tin Ä‘Äƒng má»›i</p>
        <button class="btn-create-large" (click)="openCreateForm()">
            â• Táº¡o BDS Ä‘áº§u tiÃªn
        </button>
    </div>

    <!-- Property Grid -->
    <div *ngIf="!loading && !showForm && filteredProperties.length > 0" class="property-grid">
        <div *ngFor="let prop of filteredProperties" class="property-card">
            <div class="property-image clickable" (click)="viewPropertyDetail(prop.id!)">
                <img [src]="prop.imageUrl ? 'http://localhost:3000' + prop.imageUrl : 'assets/default-property.jpg'"
                    alt="property">
                <span class="status-badge" [class]="prop.status">
                    {{ getStatusLabel(prop.status!) }}
                </span>
            </div>

            <div class="property-content">
                <h3 class="property-title clickable" (click)="viewPropertyDetail(prop.id!)">{{ prop.title }}</h3>
                <p class="property-address">ğŸ“ {{ prop.address }}</p>
                <p class="property-price">ğŸ’° {{ prop.price | number }} VNÄ</p>

                <div class="property-meta">
                    <span *ngIf="prop.bedrooms">ğŸ›ï¸ {{ prop.bedrooms }} PN</span>
                    <span *ngIf="prop.bathrooms">ğŸš¿ {{ prop.bathrooms }} WC</span>
                    <span *ngIf="prop.area">ğŸ“ {{ prop.area }} mÂ²</span>
                </div>
            </div>

            <div class="property-actions">
                <button class="btn-action btn-view" (click)="viewPropertyDetail(prop.id!)" title="Xem chi tiáº¿t">
                    ğŸ‘ï¸ Xem
                </button>
                <button class="btn-action btn-edit" (click)="openEditForm(prop)" title="Sá»­a">
                    âœï¸ Sá»­a
                </button>
                <button class="btn-action btn-delete" (click)="deleteProperty(prop.id!)" title="XÃ³a">
                    ğŸ—‘ï¸ XÃ³a
                </button>
            </div>
            <div class="property-status-actions">
                <button class="btn-action btn-publish" (click)="publishProperty(prop.id!)"
                    *ngIf="prop.status !== 'available' && prop.status !== 'sold' && prop.status !== 'rented'"
                    title="ÄÄƒng tin">
                    ğŸ“¢ ÄÄƒng tin
                </button>
                <button class="btn-action btn-unpublish" (click)="unpublishProperty(prop.id!)"
                    *ngIf="prop.status === 'available'" title="Gá»¡ tin Ä‘Äƒng">
                    ğŸš« Gá»¡ tin
                </button>
                <button class="btn-action btn-sold" (click)="markAsSold(prop.id!)" *ngIf="prop.status !== 'sold'"
                    title="ÄÃ¡nh dáº¥u Ä‘Ã£ bÃ¡n">
                    ğŸ·ï¸ ÄÃ£ bÃ¡n
                </button>
                <button class="btn-action btn-rented" (click)="markAsRented(prop.id!)" *ngIf="prop.status !== 'rented'"
                    title="ÄÃ¡nh dáº¥u Ä‘Ã£ cho thuÃª">
                    ğŸ”‘ ÄÃ£ cho thuÃª
                </button>
            </div>
        </div>
    </div>
</div>